package handlers

import (
	"fmt"
	"net/http"
	"strconv"

	"{{.GoMod}}/errors"
	"{{.GoMod}}/responses"
	{{.Domain}}_models "{{.GoMod}}/{{.Domain}}/models"
	{{.Domain}}_service "{{.GoMod}}/{{.Domain}}/service"
	{{.Domain}}_storage "{{.GoMod}}/{{.Domain}}/storage"
	"github.com/gin-gonic/gin"
	"gorm.io/gorm"
)

type {{.Domain}}Handler struct {
	{{.Domain}}Service {{.Domain}}_service.Service
}

func New{{.Domain}}Handler(db *gorm.DB) *{{.Domain}}Handler {
	{{.Domain}}Storage := {{.Domain}}_storage.New{{.CapitalizedDomain}}Storage(db)
	{{.Domain}}Service := {{.Domain}}_service.New{{.CapitalizedDomain}}Service({{.Domain}}Storage)
	return &{{.Domain}}Handler{
		{{.Domain}}Service: {{.Domain}}Service,
	}
}

func (handler *{{.Domain}}Handler) Get{{.Domain}}s(c *gin.Context) {
	{{.Domain}}s, err := handler.{{.Domain}}Service.Get{{.CapitalizedDomain}}s()
	if err != nil {
		httperror := errors.NewHttpError("Test error", http.StatusBadRequest)
		c.Error(httperror)
		return
	}

	response := responses.NewHttpResponse(http.StatusOK, {{.Domain}}s)

	c.JSON(http.StatusOK, response)
}

func (handler *{{.Domain}}Handler) Create{{.Domain}}(c *gin.Context) {
	var {{.Domain}} {{.Domain}}_models.{{.CapitalizedDomain}}

	err := c.BindJSON(&{{.Domain}})
	if err != nil {
		fmt.Println(err.Error())
		http_error := errors.NewHttpError("Object is malformed", http.StatusBadRequest)
		c.Error(http_error)
		return
	}

	err = handler.{{.Domain}}Service.Create{{.Domain}}(&{{.Domain}})
	if err != nil {
		fmt.Println(err.Error())
		http_error := errors.NewHttpError("Could not create resource object", http.StatusBadRequest)
		c.Error(http_error)
		return
	}

	c.JSON(http.StatusCreated, nil)
}

func (handler *{{.Domain}}Handler) Update{{.Domain}}(c *gin.Context) {
	var {{.Domain}} {{.Domain}}_models.{{.CapitalizedDomain}}

	err := c.BindJSON(&{{.Domain}})
	if err != nil {
		http_error := errors.NewHttpError("Object is malformed", http.StatusBadRequest)
		c.Error(http_error)
		return
	}

	err = handler.{{.Domain}}Service.Update{{.Domain}}(&{{.Domain}})
	if err != nil {
		http_error := errors.NewHttpError("Could not update resource", http.StatusBadRequest)
		c.Error(http_error)
		return
	}

	c.JSON(http.StatusNoContent, nil)
}

func (handler *{{.Domain}}Handler) Get{{.Domain}}ById(c *gin.Context) {
	idStr := c.Param("id")
	id, conversionErr := strconv.Atoi(idStr)
	if conversionErr != nil {
		http_error := errors.NewHttpError("path param malformed", http.StatusBadRequest)
		c.Error(http_error)
		return
	}

	{{.Domain}}, err := handler.{{.Domain}}Service.Get{{.CapitalizedDomain}}ById(id)
	if err != nil {
		http_error := errors.NewHttpError("Object is malformed", http.StatusBadRequest)
		c.Error(http_error)
		return
	}

	if err != nil {
		http_error := errors.NewHttpError("Object is malformed", http.StatusBadRequest)
		c.Error(http_error)
		return
	}

	response := responses.NewHttpResponse(http.StatusOK, {{.Domain}})
	c.JSON(http.StatusOK, response)
}

func (handler *{{.Domain}}Handler) Delete{{.Domain}}(c *gin.Context) {
	idStr := c.Param("id")
	id, conversionErr := strconv.Atoi(idStr)
	if conversionErr != nil {
		http_error := errors.NewHttpError("path param malformed", http.StatusBadRequest)
		c.Error(http_error)
		return
	}

	err := handler.{{.Domain}}Service.Delete{{.Domain}}(id)
	if err != nil {
		http_error := errors.NewHttpError("Couldn't delete object", http.StatusBadRequest)
		c.Error(http_error)
		return
	}

	c.JSON(http.StatusOK, nil)
}

func (handler *{{.Domain}}Handler) SetupRouter(r *gin.Engine) *gin.Engine {
	r.GET("/{{.Domain}}s", handler.Get{{.Domain}}s)
	r.POST("/{{.Domain}}s", handler.Create{{.Domain}})
	r.GET("/{{.Domain}}s/:id", handler.Get{{.Domain}}ById)
	r.PUT("/{{.Domain}}s/:id", handler.Update{{.Domain}})
	r.DELETE("/{{.Domain}}s/:id", handler.Delete{{.Domain}})

	return r
}
